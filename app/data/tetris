p5.size â† 600â€¿800
gâ†p5.g

colors â† âˆ¾âŸœ(âŠ‘ .3 p5._lerpÂ¨ âŠ¢) p5.ColÂ¨ "0"â€¿"00fdff"â€¿"ff00ff"â€¿"ffff00"â€¿"ff8000"â€¿"0000ff"â€¿"00ff00"â€¿"ff0000"
sz â† 23â€¿10
b â† szâ¥Š0
T â† {<Ë˜â‰>ğ•©}

pcs â† T âŸ¨ # tetromino definitions: (blank) I T O L J S Z
  âŸ¨âŸ©â€¿âŸ¨âŸ© # blank
  âŸ¨Â¯1,0,1, 2âŸ©â€¿âŸ¨ 0, 0,0, 0âŸ© # I
  âŸ¨ 0,0,0,Â¯1âŸ©â€¿âŸ¨ 0,Â¯1,1, 0âŸ© # T
  âŸ¨ 0,1,0, 1âŸ©â€¿âŸ¨ 0, 0,1, 1âŸ© # O
  âŸ¨Â¯1,0,1, 1âŸ©â€¿âŸ¨ 0, 0,0, 1âŸ© # L
  âŸ¨Â¯1,0,1, 1âŸ©â€¿âŸ¨ 0, 0,0,Â¯1âŸ© # J
  âŸ¨ 0,0,1, 1âŸ©â€¿âŸ¨ 1, 0,0,Â¯1âŸ© # S
  âŸ¨ 0,0,1, 1âŸ©â€¿âŸ¨Â¯1, 0,0, 1âŸ© # Z
âŸ©

hpn â† 0   # held piece number
hpu â† 0   # is held piece used up
cpn â† 4   # current piece number
cpp â† 5â€¿5 # current piece position
cpr â† 0   # current piece rotation

bsz â† 30 # block size
osz â† 20 # UI block icon size
speed â† 15 # how many frames between dropping due to gravity
nextDown â† speed # current frame
nextAm â† 4 # how many pieces to preview
nextPcsâ†âŸ¨âŸ© # future pieces

ResetTime â† {ğ•Š: nextDown â†© speed}



Blks â† {(1â€¿Â¯1Ã—âŒ½)âŸğ•¨ ğ•©âŠ‘Â¨pcs}
WithPc â† {nâ€¿iğ•Šb: nÂ¨âŒ¾((T i+cpr Blks cpn)âŠ¸âŠ‘) b}

OK â† {
  nps â† ğ•©+ğ•¨ Blks cpn
  Â¬(âˆ¨Â´â¥Š>(nps<0)âˆ¨npsâ‰¥sz)â—¶{ğ•Š: âˆ¨Â´â¥Š0â‰ (T nps)âŠ‘b}â€¿1 @
}
Move â† {
  npp â† cpp+ğ•©
  ok â† cpr OK npp
  okâ—¶(NextPieceâŸğ•¨)â€¿{ğ•Š: cppâ†©npp} @
  ok
}

SetPiece â† {
  cpn â†© ğ•©
  cpp â†© 2â€¿(4+cpn=5)
  cpr â†© 0
}
RandPiece â† {ğ•¤
  {ğ•Š: nextPcsâˆ¾â†©1+â€¢rand.Deal 7}âŸâŠ¢(1+nextAm)>â‰ nextPcs
  SetPiece âŠ‘nextPcs
  nextPcsâ†“Ëœâ†© 1
  hpu â†© 0
}
NextPiece â† {ğ•¤
  b â†© (-âˆ˜â‰ â†‘(âˆ¨ËË˜0=âŠ¢)âŠ¸/) cpnâ€¿cpp WithPc b
  RandPiece@
}


p5.Setup â† RandPiece
NoLock â† {ğ•Š: ResetTimeâŸÂ¬ cpr OK cpp+1â€¿0}
keys â† âŸ¨
  {kâ‡"down"  â‹„ tâ‡0 â‹„ STâ‡{tâ†©ğ•©} â‹„ sâ‡0 â‹„ dâ‡2 â‹„ Fâ‡{ğ•Š:ResetTime@â‹„1 Move 1â€¿0 }}
  {kâ‡"left"  â‹„ tâ‡0 â‹„ STâ‡{tâ†©ğ•©} â‹„ sâ‡7 â‹„ dâ‡4 â‹„ Fâ‡{ğ•Š:NoLock   @â‹„0 Move 0â€¿Â¯1}}
  {kâ‡"right" â‹„ tâ‡0 â‹„ STâ‡{tâ†©ğ•©} â‹„ sâ‡7 â‹„ dâ‡4 â‹„ Fâ‡{ğ•Š:NoLock   @â‹„0 Move 0â€¿1 }}
âŸ©

DrawPiece â† {offğ•Šn: (nâŠ‘colors)â€¿"2"â€¿1 g.Rect (âŠ¢âˆ¾osz+âŠ¢) off+âŒ½oszÃ—0 Blks n}
p5.Draw â† {ğ•¤
  g.BG "2"
  off â† .5Ã—p5.sz-bszÃ—âŒ½sz # offset to center board
  db â† (Â¯20â†‘ cpnâ€¿cpp WithPc âŸ¨cpn+8 â‹„ {cprâŠ¸OKâ—¶ğ•©â€¿ğ•Š ğ•©+1â€¿0}cppâŸ© WithPc b) # drawn board
  "2"â€¿1 g.Rect ((âŠ¢âˆ¾bsz+âŠ¢) off+âŒ½bszÃ—<Ë˜â‰â¼>â†•â‰¢db)âˆ¾<dbâŠcolors # draw board
  h â† .5Ã—âŠ‘off # half of sidebar size
  ((<âŸ¨p5.w-hâ‹„oszÃ—5âŸ©)+0âˆ¾Â¨(6Ã—osz)Ã—â†•nextAm) DrawPieceÂ¨ nextAmâ†‘nextPcs # next pieces
  âŸ¨hâ‹„oszÃ—5âŸ© DrawPiece hpn # held piece
  
  nextDown-â†© 1
  {ğ•Š: ResetTime@ â‹„ 1 Move 1â€¿0}âŸâŠ¢ 0=nextDown # gravity
  {ğ•Šk: # left/right/down logic
    tâ†k.t
    k.ST (p5.Pressed k.k) Ã— t+1
    k.FâŸâŠ¢ ((t=1) âˆ¨ t>ğ•©.s) âˆ§ 1=ğ•©.d|t
  }Â¨ keys
}

p5.OnKey â† {
  {ğ•ŠâŸ(1âŠ¸Move) 1â€¿0}âŸ(" "â‰¡âŠ¢) ğ•© # hard drop
  {ğ•Š: {cprâ†©ğ•© â‹„ NoLock@}âŸ(OKâŸœcpp) 4|cpr+1}âŸ((cpnâ‰¢3)âˆ§"up"â‰¡âŠ¢) ğ•© # rotate
  {ğ•Š: hpuâ†©1 â‹„ tâ†hpn â‹„ hpnâ†©cpn â‹„ 0âŠ¸â‰¡â—¶SetPieceâ€¿RandPiece t}âŸ(hpu<"z"â‰¡âŠ¢) ğ•© # hold
}